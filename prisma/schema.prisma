// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String
  role        UserRole
  profile     UserProfile?
  staff       Staff?
  patient     Patient?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Audit fields
  lastLogin   DateTime?
  loginAttempts Int    @default(0)
  lockedUntil DateTime?
  status      UserStatus @default(ACTIVE)

  // Relations - ADDED MISSING OPPOSITE RELATIONS
  createdPatients Patient[] @relation("PatientCreator")
  appointments Appointment[]
  medicalRecords MedicalRecord[]
  prescriptions Prescription[]
  labResults  LabResult[]
  billing     Billing[]
  accessLogs  AccessLog[]
  auditLogs   AuditLog[]    // ADDED: Opposite relation for AuditLog
  recordedVitalSigns VitalSign[]  // ADDED: Opposite relation for VitalSign
  
  @@map("users")
}

model UserProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  firstName   String
  lastName    String
  phone       String?
  dateOfBirth DateTime?
  address     String?
  avatar      String?
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model Staff {
  id          String   @id @default(cuid())
  userId      String   @unique
  employeeId  String   @unique
  department  String
  specialization String?
  licenseNumber String?
  hireDate    DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("staff")
}

model Patient {
  id          String   @id @default(cuid())
  mrn         String   @unique
  // Demographic Information
  firstName   String
  lastName    String
  dateOfBirth DateTime
  gender      Gender
  phone       String?
  email       String?
  address     String?
  bloodType   BloodType?
  
  // Medical Background
  allergies   String?
  medications String?
  conditions  String?
  
  // Optional link to User account
  userId      String?  @unique
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Administrative
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   User?    @relation("PatientCreator", fields: [createdById], references: [id])
  createdById String?

  // Medical Relations - ADDED MISSING OPPOSITE RELATIONS
  emergencyContact EmergencyContact?
  insurance   Insurance?
  appointments Appointment[]
  medicalRecords MedicalRecord[]
  prescriptions Prescription[]
  labResults  LabResult[]
  vitalSigns  VitalSign[]
  allergiesList Allergy[]
  diagnoses   Diagnosis[]    // ADDED: Opposite relation for Diagnosis
  billing     Billing[]      // ADDED: Opposite relation for Billing

  @@map("patients")
}

model EmergencyContact {
  id          String   @id @default(cuid())
  patientId   String   @unique
  name        String
  relationship String
  phone       String
  address     String?
  notes       String?
  
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("emergency_contacts")
}

model Insurance {
  id          String   @id @default(cuid())
  patientId   String   @unique
  provider    String
  policyNumber String
  groupNumber String?
  effectiveDate DateTime
  expirationDate DateTime?
  copay       Float?
  deductible  Float?
  
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("insurance")
}

model Allergy {
  id          String   @id @default(cuid())
  patientId   String
  allergen    String
  severity    AllergySeverity
  reaction    String
  onsetDate   DateTime?
  status      AllergyStatus @default(ACTIVE)
  notes       String?
  
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("allergies")
}

model Appointment {
  id          String   @id @default(cuid())
  patientId   String
  providerId  String
  appointmentDate DateTime
  duration    Int      @default(30)
  status      AppointmentStatus @default(SCHEDULED)
  type        AppointmentType @default(CONSULTATION)
  reason      String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations - ADDED MISSING OPPOSITE RELATION
  patient     Patient  @relation(fields: [patientId], references: [id])
  provider    User     @relation(fields: [providerId], references: [id])
  medicalRecord MedicalRecord?
  billing     Billing[]  // ADDED: Opposite relation for Billing

  @@map("appointments")
}

model MedicalRecord {
  id          String   @id @default(cuid())
  patientId   String
  providerId  String
  appointmentId String? @unique
  // Clinical Information
  chiefComplaint String
  historyOfPresentIllness String?
  pastMedicalHistory String?
  medications String?
  allergies   String?
  socialHistory String?
  familyHistory String?
  // Examination
  examination String?
  assessment  String?
  plan        String?
  // Vital Signs (can also be separate)
  height      Float?
  weight      Float?
  temperature Float?
  bloodPressure String?
  heartRate   Int?
  respiratoryRate Int?
  oxygenSaturation Float?
  
  visitDate   DateTime @default(now())
  followUpDate DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Audit fields for soft delete
  deletedAt   DateTime?
  deletedBy   String?
  isDeleted   Boolean @default(false)
  version     Int      @default(1)
  previousVersionId String?

  // Relations
  patient     Patient  @relation(fields: [patientId], references: [id])
  provider    User     @relation(fields: [providerId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id])
  prescriptions Prescription[]
  labResults  LabResult[]
  diagnoses   Diagnosis[]

  @@map("medical_records")
}

model Diagnosis {
  id          String   @id @default(cuid())
  medicalRecordId String
  patientId   String
  code        String    // ICD-10 code
  description String
  type        DiagnosisType
  status      DiagnosisStatus @default(ACTIVE)
  notes       String?
  diagnosedAt DateTime @default(now())
  
  // Relations
  medicalRecord MedicalRecord @relation(fields: [medicalRecordId], references: [id])
  patient      Patient  @relation(fields: [patientId], references: [id]) // FIXED: Now has opposite relation in Patient

  @@map("diagnoses")
}

model Prescription {
  id          String   @id @default(cuid())
  patientId   String
  providerId  String
  medicalRecordId String?
  medication  String
  dosage      String
  frequency   String
  duration    String
  route       MedicationRoute
  instructions String?
  startDate   DateTime
  endDate     DateTime?
  status      PrescriptionStatus @default(ACTIVE)
  refills     Int      @default(0)
  refillsRemaining Int @default(0)
  createdAt   DateTime @default(now())

  // Relations
  patient     Patient  @relation(fields: [patientId], references: [id])
  provider    User     @relation(fields: [providerId], references: [id])
  medicalRecord MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@map("prescriptions")
}

model LabResult {
  id          String   @id @default(cuid())
  patientId   String
  providerId  String
  medicalRecordId String?
  testName    String
  testType    LabTestType
  result      String
  normalRange String?
  units       String?
  notes       String?
  performedAt DateTime?
  reportedAt  DateTime @default(now())
  status      LabResultStatus @default(PENDING)
  attachment  String?
  
  // Relations
  patient     Patient  @relation(fields: [patientId], references: [id])
  provider    User     @relation(fields: [providerId], references: [id])
  medicalRecord MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@map("lab_results")
}

model VitalSign {
  id          String   @id @default(cuid())
  patientId   String
  recordedBy  String
  bloodPressureSystolic Int?
  bloodPressureDiastolic Int?
  heartRate   Int?
  temperature Float?
  respiratoryRate Int?
  oxygenSaturation Float?
  weight      Float?
  height      Float?
  bmi         Float?
  notes       String?
  recordedAt  DateTime @default(now())

  // Relations
  patient     Patient  @relation(fields: [patientId], references: [id])
  user        User     @relation(fields: [recordedBy], references: [id]) // FIXED: Now has opposite relation in User

  @@map("vital_signs")
}

model Billing {
  id          String   @id @default(cuid())
  patientId   String
  providerId  String
  appointmentId String?
  amount      Float
  status      BillingStatus @default(PENDING)
  serviceDate DateTime
  dueDate     DateTime
  paidDate    DateTime?
  paymentMethod String?
  insuranceClaimId String?
  notes       String?
  createdAt   DateTime @default(now())

  // Relations
  patient     Patient  @relation(fields: [patientId], references: [id]) // FIXED: Now has opposite relation in Patient
  provider    User     @relation(fields: [providerId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id]) // FIXED: Now has opposite relation in Appointment

  @@map("billing")
}

model AccessLog {
  id          String   @id @default(cuid())
  userId      String
  action      String   // VIEW, CREATE, UPDATE, DELETE
  resource    String   // PATIENT, MEDICAL_RECORD, etc.
  resourceId  String?
  ipAddress   String?
  userAgent   String?
  accessedAt  DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id])

  @@map("access_logs")
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String
  tableName   String
  recordId    String
  oldValues   Json?
  newValues   Json?
  ipAddress   String?
  userAgent   String?    // ADD THIS FIELD
  description String?    // ADD THIS FIELD
  createdAt   DateTime @default(now())

  user        User?     @relation(fields: [userId], references: [id]) // FIXED: Now has opposite relation in User

  @@map("audit_logs")
}

// Enums (keep your existing enums)
enum UserRole {
  ADMIN
  DOCTOR
  NURSE
  RECEPTIONIST
  LAB_TECH
  PHARMACIST
  PATIENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  LOCKED
}

enum Gender {
  MALE
  FEMALE
  OTHER
  UNKNOWN
}

enum BloodType {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum AppointmentType {
  CONSULTATION
  FOLLOW_UP
  EMERGENCY
  ROUTINE_CHECKUP
  SURGERY
  THERAPY
  LAB_TEST
}

enum DiagnosisType {
  PRIMARY
  SECONDARY
  CHRONIC
  ACUTE
}

enum DiagnosisStatus {
  ACTIVE
  RESOLVED
  CHRONIC
  RULED_OUT
}

enum MedicationRoute {
  ORAL
  TOPICAL
  INTRAVENOUS
  INTRAMUSCULAR
  SUBCUTANEOUS
  INHALATION
  RECTAL
}

enum PrescriptionStatus {
  ACTIVE
  COMPLETED
  DISCONTINUED
  EXPIRED
}

enum LabTestType {
  BLOOD_TEST
  URINE_TEST
  IMAGING
  BIOPSY
  CULTURE
  GENETIC
  OTHER
}

enum LabResultStatus {
  PENDING
  COMPLETED
  ABNORMAL
  CRITICAL
  CANCELLED
}

enum BillingStatus {
  PENDING
  PAID
  PARTIALLY_PAID
  INSURANCE_PENDING
  WRITTEN_OFF
}

enum AllergySeverity {
  MILD
  MODERATE
  SEVERE
  LIFE_THREATENING
}

enum AllergyStatus {
  ACTIVE
  RESOLVED
  UNCONFIRMED
}